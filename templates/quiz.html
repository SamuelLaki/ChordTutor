{% extends "layout.html" %}

{% block title %}Quiz - Match Chords{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="quiz-title">
        <h2>Match the chords to their name</h2>
    </div>

    <div class="quiz-content">
        <div class="chord-diagrams">
            <!-- Loop through chords in the quiz data -->
            {% for chord in quiz_data.chords %}
            <div class="chord-diagram" id="{{ chord.id }}" data-answer="{{ chord.correctAnswer }}">
                <img src="{{ chord.image }}" alt="{{ chord.correctAnswer }} chord" class="chord-image">
            </div>
            {% endfor %}
        </div>

        <div class="chord-options">
            <!-- Loop through options in the quiz data -->
            {% for option in quiz_data.options %}
            <div class="chord-option" id="option{{ loop.index }}" data-chord="{{ option }}">
                <div class="chord-name">{{ option }}</div>
            </div>
            {% endfor %}
        </div>
    </div>

    <div class="navigation-buttons">
        <!-- Navigation buttons -->
        {% if page_num > 1 %}
        <a href="{{ url_for('quiz_page', page_num=page_num-1) }}" class="go-back-btn">
            <div class="arrow-button left-arrow">Go Back</div>
        </a>
        {% else %}
        <a href="{{ url_for('learn') }}" class="go-back-btn">
            <div class="arrow-button left-arrow">Go Back</div>
        </a>
        {% endif %}
        
        {% if page_num < 4 %}
        <a href="{{ url_for('quiz_page', page_num=page_num+1) }}" class="next-btn">
            <div class="arrow-button right-arrow">Next</div>
        </a>
        {% else %}
        <a href="{{ url_for('learn') }}" class="next-btn">
            <div class="arrow-button right-arrow">Finish</div>
        </a>
        {% endif %}
    </div>
</div>

<!-- Pass data to JavaScript -->
<script type="text/javascript">
    var chordItemsData = {{ chord_items|tojson|safe }};
</script>

<script>
    // Get chord items data
    var chordItems = {{ chord_items|tojson|safe }};
    
    $(document).ready(function() {
        // Initialize drag and drop
        initializeQuiz();
    });
    
    function initializeQuiz() {
        // Make chord options draggable
        $(".chord-option").draggable({
            revert: "invalid",
            helper: "clone",
            containment: ".quiz-content",
            cursor: "move"
        });
        
        // Make chord diagrams droppable
        $(".chord-diagram").droppable({
            accept: ".chord-option",
            drop: handleChordDrop,
            tolerance: "intersect"
        });
        
        // Clear any existing arrows and feedback
        $(".connection-arrow").remove();
        $(".feedback-bubble").remove();
    }

    function handleChordDrop(event, ui) {
        var chordDiagram = $(this);
        var draggedOption = ui.draggable;
        
        // Get answers
        var correctAnswer = chordDiagram.data('answer');
        var userAnswer = draggedOption.data('chord');
        
        // Create or update the connection arrow
        var arrowId = chordDiagram.attr('id') + '-to-' + draggedOption.attr('id');
        var arrow = $('#' + arrowId);
        
        if (arrow.length === 0) {
            arrow = $('<div class="connection-arrow" id="' + arrowId + '"></div>');
            $('body').append(arrow); // Append to body to avoid parent container issues
        }
        
        // Remove existing feedback for this option
        draggedOption.find('.feedback-bubble').remove();
        
        // Remove existing arrow for this chord
        $('.connection-arrow[id^="' + chordDiagram.attr('id') + '"]').not('#' + arrowId).remove();
        
        // Draw the arrow
        drawConnectionArrow(chordDiagram, draggedOption, arrow);
        
        // Show feedback
        if (correctAnswer === userAnswer) {
            // Correct answer
            draggedOption.addClass('correct').removeClass('incorrect');
            var goodFeedback = $('<div class="feedback-bubble correct">excellent</div>');
            draggedOption.append(goodFeedback);
        } else {
            // Incorrect answer
            draggedOption.addClass('incorrect').removeClass('correct');
            var badFeedback = $('<div class="feedback-bubble incorrect">Revise ' + correctAnswer + '</div>');
            draggedOption.append(badFeedback);
            
            // Add link to learn the chord
            badFeedback.click(function() {
                for (var i = 0; i < chordItems.length; i++) {
                    if (chordItems[i].name === correctAnswer) {
                        window.location.href = "/learn/" + chordItems[i].id;
                        break;
                    }
                }
            });
        }
    }

    function drawConnectionArrow(from, to, arrow) {
        // Get positions relative to the viewport
        var fromRect = from[0].getBoundingClientRect();
        var toRect = to[0].getBoundingClientRect();
        
        // Calculate the starting and ending points
        var fromCenterX = fromRect.left + fromRect.width / 2;
        var fromCenterY = fromRect.top + fromRect.height / 2;
        var toCenterX = toRect.left + toRect.width / 2;
        var toCenterY = toRect.top + toRect.height / 2;
        
        // Adjust for scroll position
        var scrollX = window.pageXOffset || document.documentElement.scrollLeft;
        var scrollY = window.pageYOffset || document.documentElement.scrollTop;
        
        fromCenterX += scrollX;
        fromCenterY += scrollY;
        toCenterX += scrollX;
        toCenterY += scrollY;
        
        // Calculate angle and length
        var angle = Math.atan2(toCenterY - fromCenterY, toCenterX - fromCenterX) * 180 / Math.PI;
        var length = Math.sqrt(Math.pow(toCenterX - fromCenterX, 2) + Math.pow(toCenterY - fromCenterY, 2));
        
        // Apply to the arrow element
        arrow.css({
            'position': 'absolute',
            'left': fromCenterX + 'px',
            'top': fromCenterY + 'px',
            'width': length + 'px',
            'height': '2px',
            'background-color': 'black',
            'transform-origin': '0 0',
            'transform': 'rotate(' + angle + 'deg)',
            'z-index': '1000',
            'pointer-events': 'none' // So the arrow doesn't interfere with draggable elements
        });
        
        // Add arrow head
        var arrowHead = arrow.find('.arrow-head');
        if (arrowHead.length === 0) {
            arrowHead = $('<div class="arrow-head"></div>');
            arrow.append(arrowHead);
        }
        
        arrowHead.css({
            'position': 'absolute',
            'right': '-8px',
            'top': '-4px',
            'width': '0',
            'height': '0',
            'border-top': '5px solid transparent',
            'border-bottom': '5px solid transparent',
            'border-left': '8px solid black'
        });
    }
    
    // Handle window resize to reposition arrows
    $(window).resize(function() {
        $('.connection-arrow').each(function() {
            var arrowId = $(this).attr('id');
            var parts = arrowId.split('-to-');
            if (parts.length === 2) {
                var fromElement = $('#' + parts[0]);
                var toElement = $('#' + parts[1]);
                if (fromElement.length > 0 && toElement.length > 0) {
                    drawConnectionArrow(fromElement, toElement, $(this));
                }
            }
        });
    });
</script>
{% endblock %}
